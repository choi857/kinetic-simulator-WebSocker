<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketåŠ¨æ€æ•°æ®æ¨¡æ‹Ÿå™¨</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        .section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.received {
            color: #68d391;
        }
        .log-entry.sent {
            color: #63b3ed;
        }
        .log-entry.error {
            color: #fc8181;
        }
        .log-entry.info {
            color: #f6e05e;
        }
        .template-editor {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .field-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .field-path {
            flex: 1;
            font-weight: 600;
            color: #495057;
            margin-right: 10px;
        }
        .field-type-select {
            width: 150px;
            margin-right: 10px;
        }
        .field-value {
            flex: 2;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #6c757d;
        }
        .field-limits {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
        .field-limits input {
            width: 80px;
            margin: 0 5px;
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
        }
        .field-limits label {
            font-size: 11px;
            color: #6c757d;
            margin: 0 2px;
        }
        .preview-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .preview-json {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .connection-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .connection-count {
            font-weight: 600;
            color: #1976d2;
        }
        /* æ‚¬æµ®æ—¥å¿—å®¹å™¨ */
        #floatingLogContainer {
            position: fixed;
            top: 80px;
            right: 40px;
            width: 372px;
            max-height: 70vh;
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            z-index: 9999;
            overflow-y: auto;
            padding: 18px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            transition: opacity 0.2s, visibility 0.2s;
        }
        #floatingLogContainer.hide {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        /* æ‚¬æµ®æ—¥å¿—å¼€å…³æŒ‰é’® */
        #toggleLogBtn {
            position: fixed;
            right: 48px;
            bottom: 48px;
            z-index: 10000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, box-shadow 0.2s;
        }
        #toggleLogBtn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            box-shadow: 0 8px 32px rgba(0,0,0,0.22);
        }
        .mode-btn {
            /* ä¸å†å•ç‹¬è®¾ç½®å®½é«˜ã€å­—ä½“ã€paddingã€åœ†è§’ç­‰ï¼Œå…¨éƒ¨ç»§æ‰¿button */
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: #fff !important;
            border: 1px solid #667eea !important;
        }
        .push-interval-group {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”Œ WebSocketåŠ¨æ€æ•°æ®æ¨¡æ‹Ÿå™¨</h1>
            <p>æ”¯æŒæ™ºèƒ½æ•°æ®ç±»å‹è¯†åˆ«å’Œäº¤äº’å¼æ¨¡æ¿ç¼–è¾‘</p>
        </div>
        
        <div class="content">
            <!-- å·¦ä¾§ï¼šè¿æ¥å’Œæ¨¡æ¿ç¼–è¾‘ -->
            <div class="left-panel">
                <!-- è¿æ¥æ§åˆ¶ -->
                <div class="section">
                    <h3>ğŸ”— è¿æ¥æ§åˆ¶</h3>
                    <div class="connection-info">
                        <span>å½“å‰è¿æ¥æ•°: <span id="connectionCount" class="connection-count">0</span></span>
                        <span id="connectionStatus" class="status disconnected">æœªè¿æ¥</span>
                    </div>
                    <div class="controls">
                        <div class="push-interval-group">
                            <label style="margin-right:8px; font-weight:400; color:#495057;white-space:nowrap;">
                                æ¨é€é¢‘ç‡(ç§’):
                                <input id="pushIntervalInput" type="number" min="0.1" step="0.1" value="5" style="width:60px;display:inline-block;margin-left:4px;vertical-align:middle;">
                            </label>
                            <button id="changePushIntervalBtn" onclick="changePushInterval()">ä¿®æ”¹æ¨é€é¢‘ç‡</button>
                        </div>
                        <div class="push-interval-group" style="display:none;">
                            <label style="margin-right:8px; font-weight:400; color:#495057;white-space:nowrap;">
                                ç”Ÿæˆç»„æ•°:
                                <input id="groupCountInput" type="number" min="1" max="3" value="1" style="width:60px;display:inline-block;margin-left:4px;vertical-align:middle;">
                            </label>
                        </div>
                        <div style="display:inline-block;width:100%;margin-top:4px;">
                            <button id="connectBtn" onclick="connect()">è¿æ¥</button>
                            <button id="disconnectBtn" onclick="disconnect()" disabled>æ–­å¼€</button>
                            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                            <button onclick="getConnectionCount()">åˆ·æ–°è¿æ¥æ•°</button>
                            <button id="normalModeBtn" type="button" class="mode-btn" onclick="toggleMode(false)">æ™®é€šæ¨¡å¼</button>
                            <button id="advancedModeBtn" type="button" class="mode-btn" onclick="toggleMode(true)">é«˜çº§æ¨¡å¼</button>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡æ¿ç¼–è¾‘å™¨ -->
                <div class="section">
                    <h3>ğŸ“ äº¤äº’å¼æ¨¡æ¿ç¼–è¾‘å™¨</h3>
                    <div class="input-group">
                        <label for="jsonInput">è¾“å…¥JSONæ¨¡æ¿:</label>
                        <textarea id="jsonInput" rows="8" placeholder='{"user_id": 0, "user_name": "", "age": 0, "email": "", "is_active": false}'></textarea>
                    </div>
                    <div class="controls">
                        <button onclick="parseAndEditTemplate()">è§£æå¹¶ç¼–è¾‘</button>
                        <button onclick="generateRandomTemplate()">ç”Ÿæˆç¤ºä¾‹æ¨¡æ¿</button>
                        <button onclick="clearTemplate()">æ¸…ç©ºæ¨¡æ¿</button>
                        <button id="testFieldEditorBtn">æµ‹è¯•å­—æ®µç¼–è¾‘å™¨</button>
                    </div>
                    
                    <div id="templateEditor" class="template-editor" style="display: none;">
                        <h4>å­—æ®µç±»å‹é…ç½®</h4>
                        <div id="fieldList"></div>
                        <div class="controls">
                            <button id="applyTemplateBtn" onclick="applyTemplate()">åº”ç”¨æ¨¡æ¿</button>
                            <button id="updateTemplateBtn" onclick="updateAndReconnectTemplate()" style="display:none;">æ›´æ–°åº”ç”¨æ¨¡æ¿</button>
                            <button onclick="previewTemplate()">é¢„è§ˆæ•°æ®</button>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®é¢„è§ˆ -->
                <div class="section">
                    <h3>ğŸ‘€ æ•°æ®é¢„è§ˆ</h3>
                    <div class="preview-section">
                        <div id="previewContent" class="preview-json">ç­‰å¾…ç”Ÿæˆæ•°æ®...</div>
                    </div>
    </div>
    </div>
    </div>
    </div>

    <!-- æ‚¬æµ®æ—¥å¿—å®¹å™¨ -->
    <div id="floatingLogContainer"></div>
    <!-- æ‚¬æµ®æ—¥å¿—å¼€å…³æŒ‰é’® -->
    <button id="toggleLogBtn" title="æ˜¾ç¤º/éšè—å®æ—¶æ—¥å¿—" onclick="toggleLog()">ğŸ“</button>

    <script>
        let ws = null;
        let isConnected = false;
        let currentTemplate = null;
        let fieldTypes = {};
        let fieldLimits = {}; // æ–°å¢ï¼šå­˜å‚¨å­—æ®µçš„æœ€å¤§å€¼æœ€å°å€¼é™åˆ¶
        let mode = "normal";

        // æ•°æ®ç±»å‹é€‰é¡¹
        const dataTypes = [
            { value: 'auto', label: 'è‡ªåŠ¨è¯†åˆ«' },
            { value: 'string', label: 'å­—ç¬¦ä¸²' },
            { value: 'int', label: 'æ•´æ•°' },
            { value: 'double', label: 'æµ®ç‚¹æ•°' },
            { value: 'boolean', label: 'å¸ƒå°”å€¼' },
            { value: 'array', label: 'æ•°ç»„' },
            { value: 'object', label: 'å¯¹è±¡' },
            { value: 'email', label: 'é‚®ç®±' },
            { value: 'phone', label: 'æ‰‹æœºå·' },
            { value: 'date', label: 'æ—¥æœŸæ—¶é—´' },
            { value: 'timestamp_realtime', label: 'å®æ—¶æ—¶é—´æˆ³(æ¯«ç§’)' },
            { value: 'timestamp_editable', label: 'å¯ä¿®æ”¹æ—¶é—´æˆ³(æ¯«ç§’)' },
            { value: 'ip', label: 'IPåœ°å€' },
            { value: 'url', label: 'URL' },
            { value: 'uuid', label: 'UUID' },
            { value: 'name', label: 'å§“å' },
            { value: 'color', label: 'é¢œè‰²' },
            { value: 'age', label: 'å¹´é¾„(1-100)' },
            { value: 'year', label: 'å¹´ä»½(2000-2024)' },
            { value: 'month', label: 'æœˆä»½(1-12)' },
            { value: 'day', label: 'æ—¥æœŸ(1-31)' },
            { value: 'hour', label: 'å°æ—¶(0-23)' },
            { value: 'minute', label: 'åˆ†é’Ÿ(0-59)' },
            { value: 'second', label: 'ç§’(0-59)' },
            { value: 'port', label: 'ç«¯å£(1024-65535)' },
            { value: 'id', label: 'ID(1-1000000)' },
            { value: 'price', label: 'ä»·æ ¼(0-1000)' },
            { value: 'rate', label: 'æ¯”ç‡(0-100%)' },
            { value: 'score', label: 'åˆ†æ•°(0-10)' },
            { value: 'temperature', label: 'æ¸©åº¦(-10-40)' },
            { value: 'latitude', label: 'çº¬åº¦(-90-90)' },
            { value: 'longitude', label: 'ç»åº¦(-180-180)' }
        ];

        function isNumericType(type) {
            return [
                'int', 'double', 'age', 'year', 'month', 'day', 'hour', 'minute', 'second',
                'port', 'id', 'price', 'rate', 'score', 'temperature', 'latitude', 'longitude'
            ].includes(type);
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('å·²ç»è¿æ¥', 'info');
                return;
            }

            // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨åŒ¹é…å½“å‰åè®®å’Œä¸»æœº
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}/`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                isConnected = true;
                updateConnectionStatus();
                updateTemplateButtons();
                log('WebSocketè¿æ¥å·²å»ºç«‹', 'info');
            };

            ws.onmessage = function(event) {
                log('æ”¶åˆ°: ' + event.data, 'received');
                    try {
                        const data = JSON.parse(event.data);
                    updatePreview(JSON.stringify(data, null, 2));
                    } catch (e) {
                    updatePreview(event.data);
                }
            };

            ws.onclose = function() {
                isConnected = false;
                updateConnectionStatus();
                updateTemplateButtons();
                log('WebSocketè¿æ¥å·²å…³é—­', 'info');
            };

            ws.onerror = function(error) {
                log('WebSocketé”™è¯¯: ' + error, 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (isConnected) {
                status.textContent = 'å·²è¿æ¥';
                status.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                status.textContent = 'æœªè¿æ¥';
                status.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function updateTemplateButtons() {
            const applyBtn = document.getElementById('applyTemplateBtn');
            const updateBtn = document.getElementById('updateTemplateBtn');
            if (isConnected) {
                applyBtn.style.display = 'none';
                updateBtn.style.display = '';
            } else {
                applyBtn.style.display = '';
                updateBtn.style.display = 'none';
            }
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('floatingLogContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('floatingLogContainer').innerHTML = '';
        }

        function getConnectionCount() {
            fetch('/api/connection-count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('connectionCount').textContent = data.count;
                })
                .catch(error => {
                    log('è·å–è¿æ¥æ•°å¤±è´¥: ' + error, 'error');
                });
        }

        function parseAndEditTemplate() {
            const jsonInput = document.getElementById('jsonInput').value.trim();
            if (!jsonInput) {
                alert('è¯·è¾“å…¥JSONæ¨¡æ¿');
                return;
            }

            try {
                const template = JSON.parse(jsonInput);
                currentTemplate = template;
                fieldTypes = {};
                renderFieldEditor(template);
                document.getElementById('templateEditor').style.display = 'block';
                log('æ¨¡æ¿è§£ææˆåŠŸï¼Œè¯·é…ç½®å­—æ®µç±»å‹', 'info');
            } catch (error) {
                alert('JSONæ ¼å¼é”™è¯¯: ' + error.message);
                log('JSONè§£æå¤±è´¥: ' + error.message, 'error');
            }
        }

        function renderFieldEditor(obj, path = '') {
            const fieldList = document.getElementById('fieldList');
            fieldList.innerHTML = '';
            // é«˜çº§æ¨¡å¼ä¸‹ï¼Œå…è®¸ä¸ºä»»æ„è·¯å¾„é…ç½®ï¼›æ™®é€šæ¨¡å¼ä¸‹åªå…è®¸[0]è·¯å¾„
            function addFields(obj, currentPath) {
                if (Array.isArray(obj)) {
                    if (obj.length > 0) {
                        if (mode === 'advanced') {
                            for (let i = 0; i < Math.min(obj.length, 3); i++) {
                                addFields(obj[i], currentPath + '[' + i + ']');
                            }
                        } else {
                            addFields(obj[0], currentPath + '[0]');
                        }
                    }
                } else if (typeof obj === 'object' && obj !== null) {
                    for (const [key, value] of Object.entries(obj)) {
                        const fieldPath = currentPath ? `${currentPath}.${key}` : key;
                        if (mode === 'normal' && /\[\d+\]/.test(fieldPath) && !/\[0\]/.test(fieldPath)) continue;
                        // --- dataå­—æ®µç‰¹æ®Šå¤„ç† ---
                        if (fieldPath === 'data') {
                            const fieldRow = document.createElement('div');
                            fieldRow.className = 'field-row';
                            const fieldPathSpan = document.createElement('div');
                            fieldPathSpan.className = 'field-path';
                            fieldPathSpan.textContent = fieldPath;
                            fieldRow.appendChild(fieldPathSpan);
                            // ç±»å‹ä¸‹æ‹‰æ¡†
                            const typeSelect = document.createElement('select');
                            typeSelect.className = 'field-type-select';
                            ['array', 'object'].forEach(type => {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = type === 'array' ? 'æ•°ç»„' : 'å¯¹è±¡';
                                typeSelect.appendChild(option);
                            });
                            // è‡ªåŠ¨è¯†åˆ«ç±»å‹
                            typeSelect.value = Array.isArray(value) ? 'array' : 'object';
                            typeSelect.onchange = function() {
                                // åˆ‡æ¢ç±»å‹æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æ¨¡æ¿å†…å®¹
                                if (this.value === 'array' && !Array.isArray(value)) {
                                    currentTemplate.data = [{}];
                                } else if (this.value === 'object' && Array.isArray(value)) {
                                    currentTemplate.data = {};
                                }
                                // é‡æ–°æ¸²æŸ“
                                renderFieldEditor(currentTemplate);
                            };
                            fieldRow.appendChild(typeSelect);
                            // dataå€¼æ˜¾ç¤º
                            const fieldValue = document.createElement('div');
                            fieldValue.className = 'field-value';
                            fieldValue.textContent = JSON.stringify(value);
                            fieldRow.appendChild(fieldValue);
                            fieldList.appendChild(fieldRow);
                            // é€’å½’
                            if (typeof value === 'object' && value !== null) {
                                addFields(value, fieldPath);
                            }
                            continue;
                        }
                        // --- å…¶ä»–å­—æ®µåŸæœ‰æ¸²æŸ“é€»è¾‘ ---
                        const fieldRow = document.createElement('div');
                        fieldRow.className = 'field-row';
                        const fieldPathSpan = document.createElement('div');
                        fieldPathSpan.className = 'field-path';
                        fieldPathSpan.textContent = fieldPath;
                        const typeSelect = document.createElement('select');
                        typeSelect.className = 'field-type-select';
                        typeSelect.onchange = function() {
                            fieldTypes[fieldPath] = this.value;
                            if (minInput) minInput.value = '';
                            if (maxInput) maxInput.value = '';
                            if (defaultInput) defaultInput.value = '';
                            if (isNumericType(this.value)) {
                                minInput.type = 'number';
                                maxInput.type = 'number';
                                minInput.placeholder = 'æœ€å°å€¼';
                                maxInput.placeholder = 'æœ€å¤§å€¼';
                                defaultInput.type = 'number';
                                defaultInput.placeholder = 'é»˜è®¤å€¼';
                                minInput.disabled = false;
                                maxInput.disabled = false;
                                defaultInput.disabled = false;
                                if (minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip') minInput.nextElementSibling.remove();
                            } else if (this.value === 'date') {
                                minInput.type = 'datetime-local';
                                maxInput.type = 'datetime-local';
                                minInput.placeholder = 'æœ€å°æ—¥æœŸæ—¶é—´';
                                maxInput.placeholder = 'æœ€å¤§æ—¥æœŸæ—¶é—´';
                                defaultInput.type = 'datetime-local';
                                defaultInput.placeholder = 'é»˜è®¤æ—¥æœŸæ—¶é—´';
                                minInput.disabled = false;
                                maxInput.disabled = false;
                                defaultInput.disabled = false;
                                if (minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip') minInput.nextElementSibling.remove();
                            } else if (this.value === 'timestamp_realtime') {
                                minInput.type = 'number';
                                maxInput.type = 'number';
                                defaultInput.type = 'number';
                                minInput.value = '';
                                maxInput.value = '';
                                defaultInput.value = '';
                                minInput.disabled = true;
                                maxInput.disabled = true;
                                defaultInput.disabled = true;
                                if (!(minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip')) {
                                    const tip = document.createElement('span');
                                    tip.className = 'ts-tip';
                                    tip.style.color = '#888';
                                    tip.style.marginLeft = '8px';
                                    minInput.parentNode.insertBefore(tip, minInput.nextSibling);
                                }
                            } else if (this.value === 'timestamp_editable') {
                                minInput.type = 'number';
                                maxInput.type = 'number';
                                defaultInput.type = 'number';
                                minInput.placeholder = 'æœ€å°æ—¶é—´æˆ³(æ¯«ç§’)';
                                maxInput.placeholder = 'æœ€å¤§æ—¶é—´æˆ³(æ¯«ç§’)';
                                defaultInput.placeholder = 'é»˜è®¤æ—¶é—´æˆ³(æ¯«ç§’)';
                                minInput.disabled = false;
                                maxInput.disabled = false;
                                defaultInput.disabled = false;
                                if (minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip') minInput.nextElementSibling.remove();
                            } else {
                                minInput.type = 'text';
                                maxInput.type = 'text';
                                minInput.placeholder = 'æœ€å°å€¼';
                                maxInput.placeholder = 'æœ€å¤§å€¼';
                                defaultInput.type = 'text';
                                defaultInput.placeholder = 'é»˜è®¤å€¼';
                                minInput.disabled = false;
                                maxInput.disabled = false;
                                defaultInput.disabled = false;
                                if (minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip') minInput.nextElementSibling.remove();
                            }
                        };
                        dataTypes.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type.value;
                            option.textContent = type.label;
                            typeSelect.appendChild(option);
                        });
                        const defaultType = getDefaultType(key, value);
                        typeSelect.value = defaultType;
                        fieldTypes[fieldPath] = defaultType;
                        const fieldValue = document.createElement('div');
                        fieldValue.className = 'field-value';
                        fieldValue.textContent = JSON.stringify(value);
                        const fieldLimits = document.createElement('div');
                        fieldLimits.className = 'field-limits';
                        let minInput = null, maxInput = null, defaultInput = null;
                        if (isNumericType(defaultType) || defaultType === 'date') {
                            const minLabel = document.createElement('label');
                            minLabel.textContent = 'æœ€å°:';
                            fieldLimits.appendChild(minLabel);
                            minInput = document.createElement('input');
                            minInput.type = isNumericType(defaultType) ? 'number' : (defaultType === 'date' ? 'datetime-local' : 'text');
                            minInput.placeholder = isNumericType(defaultType) ? 'æœ€å°å€¼' : (defaultType === 'date' ? 'æœ€å°æ—¥æœŸæ—¶é—´' : 'æœ€å°å€¼');
                            minInput.onchange = function() {
                                if (!fieldLimitsObj[fieldPath]) fieldLimitsObj[fieldPath] = {};
                                fieldLimitsObj[fieldPath].min = this.value;
                            };
                            fieldLimits.appendChild(minInput);
                            const maxLabel = document.createElement('label');
                            maxLabel.textContent = 'æœ€å¤§:';
                            fieldLimits.appendChild(maxLabel);
                            maxInput = document.createElement('input');
                            maxInput.type = isNumericType(defaultType) ? 'number' : (defaultType === 'date' ? 'datetime-local' : 'text');
                            maxInput.placeholder = isNumericType(defaultType) ? 'æœ€å¤§å€¼' : (defaultType === 'date' ? 'æœ€å¤§æ—¥æœŸæ—¶é—´' : 'æœ€å¤§å€¼');
                            maxInput.onchange = function() {
                                if (!fieldLimitsObj[fieldPath]) fieldLimitsObj[fieldPath] = {};
                                fieldLimitsObj[fieldPath].max = this.value;
                            };
                            fieldLimits.appendChild(maxInput);
                            // é»˜è®¤å€¼è¾“å…¥æ¡†
                            const defaultLabel = document.createElement('label');
                            defaultLabel.textContent = 'é»˜è®¤:';
                            fieldLimits.appendChild(defaultLabel);
                            defaultInput = document.createElement('input');
                            defaultInput.type = minInput.type;
                            defaultInput.placeholder = minInput.type === 'datetime-local' ? 'é»˜è®¤æ—¥æœŸæ—¶é—´' : 'é»˜è®¤å€¼';
                            defaultInput.onchange = function() {
                                if (!fieldDefaultsObj[fieldPath]) fieldDefaultsObj[fieldPath] = {};
                                fieldDefaultsObj[fieldPath].value = this.value;
                            };
                            fieldLimits.appendChild(defaultInput);
                        } else {
                            // é»˜è®¤å€¼è¾“å…¥æ¡†
                            const defaultLabel = document.createElement('label');
                            defaultLabel.textContent = 'é»˜è®¤:';
                            fieldLimits.appendChild(defaultLabel);
                            defaultInput = document.createElement('input');
                            defaultInput.type = 'text';
                            defaultInput.placeholder = 'é»˜è®¤å€¼';
                            defaultInput.onchange = function() {
                                if (!fieldDefaultsObj[fieldPath]) fieldDefaultsObj[fieldPath] = {};
                                fieldDefaultsObj[fieldPath].value = this.value;
                            };
                            fieldLimits.appendChild(defaultInput);
                        }
                        fieldRow.appendChild(fieldPathSpan);
                        fieldRow.appendChild(typeSelect);
                        fieldRow.appendChild(fieldValue);
                        fieldRow.appendChild(fieldLimits);
                        fieldList.appendChild(fieldRow);
                        if (typeof value === 'object' && value !== null) {
                            addFields(value, fieldPath);
                        }
                    }
                }
            }
            let fieldLimitsObj = fieldLimits;
            let fieldDefaultsObj = {};
            addFields(obj, path);
            window._fieldDefaultsObj = fieldDefaultsObj;
        }

        function getDefaultType(key, value) {
            const lowerKey = key.toLowerCase();
            
            // æ ¹æ®å­—æ®µåå’Œå€¼ç±»å‹æ¨æ–­é»˜è®¤ç±»å‹
            if (typeof value === 'number') {
                if (Number.isInteger(value)) {
                    if (lowerKey.includes('age')) return 'age';
                    if (lowerKey.includes('year')) return 'year';
                    if (lowerKey.includes('month')) return 'month';
                    if (lowerKey.includes('day')) return 'day';
                    if (lowerKey.includes('hour')) return 'hour';
                    if (lowerKey.includes('minute')) return 'minute';
                    if (lowerKey.includes('second')) return 'second';
                    if (lowerKey.includes('port')) return 'port';
                    if (lowerKey.includes('id')) return 'id';
                    if (lowerKey.includes('type')) return 'int';
                    return 'int';
                } else {
                    if (lowerKey.includes('price')) return 'price';
                    if (lowerKey.includes('rate')) return 'rate';
                    if (lowerKey.includes('score')) return 'score';
                    if (lowerKey.includes('temperature')) return 'temperature';
                    if (lowerKey.includes('latitude')) return 'latitude';
                    if (lowerKey.includes('longitude')) return 'longitude';
                    if (lowerKey.includes('x') || lowerKey.includes('y') || lowerKey.includes('z')) return 'double';
                    if (lowerKey.includes('a') || lowerKey.includes('d')) return 'double';
                    return 'double';
                }
            } else if (typeof value === 'boolean') {
                return 'boolean';
            } else if (typeof value === 'string') {
                if (lowerKey.includes('email')) return 'email';
                if (lowerKey.includes('phone') || lowerKey.includes('mobile')) return 'phone';
                if (lowerKey.includes('date') || lowerKey.includes('time')) return 'date';
                if (lowerKey.includes('ip')) return 'ip';
                if (lowerKey.includes('url')) return 'url';
                if (lowerKey.includes('uuid') || lowerKey.includes('guid')) return 'uuid';
                if (lowerKey.includes('name')) return 'name';
                if (lowerKey.includes('color')) return 'color';
                return 'string';
            } else if (Array.isArray(value)) {
                return 'array';
            } else if (typeof value === 'object' && value !== null) {
                return 'object';
            }
            
            return 'auto';
        }

        function applyTemplate() {
            if (!currentTemplate) {
                alert('è¯·å…ˆè§£ææ¨¡æ¿');
                return;
            }
            if (!isConnected) {
                connect();
                let tryCount = 0;
                const trySend = setInterval(() => {
                    if (isConnected) {
                        clearInterval(trySend);
                        _doApplyTemplate();
                    } else if (++tryCount > 20) {
                        clearInterval(trySend);
                        alert('è¿æ¥è¶…æ—¶ï¼Œæ— æ³•åº”ç”¨æ¨¡æ¿');
                    }
                }, 200);
            } else {
                _doApplyTemplate();
            }
        }

        function _doApplyTemplate() {
            const pushInterval = parseFloat(document.getElementById('pushIntervalInput').value) || 5;
            const groupCount = Math.max(1, Math.min(3, parseInt(document.getElementById('groupCountInput').value) || 1));
            const modifiedTemplate = modifyTemplateByTypes(currentTemplate, fieldTypes);
            const newFieldLimits = {};
            document.querySelectorAll('.field-row').forEach(row => {
                const path = row.querySelector('.field-path').textContent;
                const minInput = row.querySelector('.field-limits input[placeholder^="æœ€å°"]');
                const maxInput = row.querySelector('.field-limits input[placeholder^="æœ€å¤§"]');
                if (minInput && minInput.value !== "") {
                    if (!newFieldLimits[path]) newFieldLimits[path] = {};
                    newFieldLimits[path].min = minInput.value;
                }
                if (maxInput && maxInput.value !== "") {
                    if (!newFieldLimits[path]) newFieldLimits[path] = {};
                    newFieldLimits[path].max = maxInput.value;
                }
            });
            const fieldDefaults = window._fieldDefaultsObj || {};
            const templateConfig = {
                template: modifiedTemplate,
                fieldTypes: fieldTypes,
                fieldLimits: newFieldLimits,
                fieldDefaults: fieldDefaults,
                pushInterval: pushInterval,
                groupCount: groupCount,
                mode: mode // å…³é”®ï¼šå‘é€å½“å‰æ¨¡å¼
            };
            const templateJson = JSON.stringify(templateConfig);
            ws.send(templateJson);
            log('å‘é€æ¨¡æ¿é…ç½®: ' + templateJson, 'sent');
            document.getElementById('jsonInput').value = JSON.stringify(modifiedTemplate, null, 2);
        }

        function modifyTemplateByTypes(template, types) {
            const modified = JSON.parse(JSON.stringify(template));
            
            function modifyObject(obj, path = '') {
                if (Array.isArray(obj)) {
                    // å¤„ç†æ•°ç»„ç±»å‹
                    if (obj.length > 0) {
                        modifyObject(obj[0], path + '[0]');
                    }
                } else if (typeof obj === 'object' && obj !== null) {
                    // å¤„ç†å¯¹è±¡ç±»å‹
                    for (const [key, value] of Object.entries(obj)) {
                        const fieldPath = path ? `${path}.${key}` : key;
                        const type = types[fieldPath];
                        
                        if (type && type !== 'auto') {
                            // æ ¹æ®é€‰æ‹©çš„ç±»å‹è®¾ç½®é»˜è®¤å€¼
                            switch (type) {
                                case 'string':
                                case 'email':
                                case 'phone':
                                case 'date':
                                case 'ip':
                                case 'url':
                                case 'uuid':
                                case 'name':
                                case 'color':
                                    obj[key] = '';
                                    break;
                                case 'int':
                                case 'age':
                                case 'year':
                                case 'month':
                                case 'day':
                                case 'hour':
                                case 'minute':
                                case 'second':
                                case 'port':
                                case 'id':
                                    obj[key] = 0;
                                    break;
                                case 'double':
                                case 'price':
                                case 'rate':
                                case 'score':
                                case 'temperature':
                                case 'latitude':
                                case 'longitude':
                                    obj[key] = 0.0;
                                    break;
                                case 'boolean':
                                    obj[key] = false;
                                    break;
                                case 'array':
                                    // ä¿æŒæ•°ç»„ç»“æ„ï¼Œåªä¿®æ”¹æ•°ç»„å…ƒç´ çš„é»˜è®¤å€¼
                                    if (Array.isArray(obj[key]) && obj[key].length > 0) {
                                        // é€’å½’å¤„ç†æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
                                        modifyObject(obj[key][0], fieldPath + '[0]');
                                    }
                                    break;
                                case 'object':
                                    // ä¿æŒå¯¹è±¡ç»“æ„ï¼Œåªä¿®æ”¹å¯¹è±¡å­—æ®µçš„é»˜è®¤å€¼
                                    if (typeof obj[key] === 'object' && obj[key] !== null) {
                                        modifyObject(obj[key], fieldPath);
                                    }
                                    break;
                            }
                        }
                        
                        // é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡å’Œæ•°ç»„
                        if (typeof obj[key] === 'object' && obj[key] !== null) {
                            modifyObject(obj[key], fieldPath);
                        }
                    }
                }
            }
            
            modifyObject(modified);
            return modified;
        }

        function previewTemplate() {
            if (!currentTemplate) {
                alert('è¯·å…ˆè§£ææ¨¡æ¿');
                return;
            }

            const modifiedTemplate = modifyTemplateByTypes(currentTemplate, fieldTypes);
            updatePreview(JSON.stringify(modifiedTemplate, null, 2));
            log('æ¨¡æ¿é¢„è§ˆå·²æ›´æ–°', 'info');
        }

        function updatePreview(content) {
            document.getElementById('previewContent').textContent = content;
        }

        function generateRandomTemplate() {
            const templates = [
                {
                    "user_id": 0,
                    "user_name": "",
                    "user_email": "",
                    "age": 0,
                    "phone": "",
                    "is_active": false,
                    "score": 0.0,
                    "registration_date": ""
                },
                {
                    "product_id": 0,
                    "product_name": "",
                    "price": 0.0,
                    "category": "",
                    "in_stock": false,
                    "rating": 0.0,
                    "tags": [""]
                },
                {
                    "sensor_id": 0,
                    "temperature": 0.0,
                    "humidity": 0.0,
                    "location": {
                        "latitude": 0.0,
                        "longitude": 0.0
                    },
                    "timestamp": "",
                    "is_online": false
                }
            ];
            
            const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
            document.getElementById('jsonInput').value = JSON.stringify(randomTemplate, null, 2);
            log('å·²ç”Ÿæˆç¤ºä¾‹æ¨¡æ¿', 'info');
        }

        function clearTemplate() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('templateEditor').style.display = 'none';
            document.getElementById('fieldList').innerHTML = '';
            currentTemplate = null;
            fieldTypes = {};
            fieldLimits = {}; // æ¸…ç©ºå­—æ®µé™åˆ¶
            updatePreview('ç­‰å¾…ç”Ÿæˆæ•°æ®...');
            log('æ¨¡æ¿å·²æ¸…ç©º', 'info');
        }

        // å®šæœŸæ›´æ–°è¿æ¥æ•°
        setInterval(getConnectionCount, 5000);
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            getConnectionCount();
            // é»˜è®¤æ¨¡æ¿
            const defaultTemplate = {"data": [{"id": 4341, "type": 1, "x": -14.392636016309739, "y": 45.06815540454186, "z": 0.0, "a": 4.927792, "d": 13.49925944656905}]};
            document.getElementById('jsonInput').value = JSON.stringify(defaultTemplate, null, 2);
            parseAndEditTemplate();
            // æŒ‰é’®é«˜äº®åˆå§‹åŒ–
            document.getElementById('normalModeBtn').classList.add('active');
            // æ·»åŠ æµ‹è¯•æŒ‰é’®ç”¨äºéªŒè¯åŠŸèƒ½
            const testButton = document.getElementById('testFieldEditorBtn');
            testButton.onclick = function() {
                const testTemplate = {
                    "user_id": 0,
                    "user_name": "",
                    "age": 0,
                    "email": "",
                    "is_active": false,
                    "location": {
                        "latitude": 0.0,
                        "longitude": 0.0
                    }
                };
                document.getElementById('jsonInput').value = JSON.stringify(testTemplate, null, 2);
                parseAndEditTemplate();
            };
        });

        function toggleLog() {
            const logContainer = document.getElementById('floatingLogContainer');
            logContainer.classList.toggle('hide');
        }

        function changePushInterval() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('è¯·å…ˆå»ºç«‹WebSocketè¿æ¥');
                return;
            }
            const pushInterval = parseFloat(document.getElementById('pushIntervalInput').value) || 1;
            if (pushInterval < 0.1) {
                alert('æ¨é€é¢‘ç‡ä¸èƒ½å°äº0.1ç§’');
                return;
            }
            const msg = JSON.stringify({ pushInterval });
            ws.send(msg);
            log('å‘é€æ¨é€é¢‘ç‡è°ƒæ•´: ' + msg, 'sent');
        }

        function updateAndReconnectTemplate() {
            if (!currentTemplate) {
                alert('è¯·å…ˆè§£ææ¨¡æ¿');
                return;
            }
            if (ws) {
                ws.onclose = function() {
                    isConnected = false;
                    updateConnectionStatus();
                    updateTemplateButtons();
                    log('WebSocketè¿æ¥å·²å…³é—­ï¼Œå‡†å¤‡é‡è¿', 'info');
                    // æ–­å¼€åè‡ªåŠ¨é‡è¿å¹¶åº”ç”¨æ¨¡æ¿
                    connect();
                    let tryCount = 0;
                    const trySend = setInterval(() => {
                        if (isConnected) {
                            clearInterval(trySend);
                            _doApplyTemplate();
                        } else if (++tryCount > 20) {
                            clearInterval(trySend);
                            alert('é‡è¿è¶…æ—¶ï¼Œæ— æ³•åº”ç”¨æ¨¡æ¿');
                        }
                    }, 200);
                };
                ws.close();
            } else {
                connect();
                let tryCount = 0;
                const trySend = setInterval(() => {
                    if (isConnected) {
                        clearInterval(trySend);
                        _doApplyTemplate();
                    } else if (++tryCount > 20) {
                        clearInterval(trySend);
                        alert('é‡è¿è¶…æ—¶ï¼Œæ— æ³•åº”ç”¨æ¨¡æ¿');
                    }
                }, 200);
            }
        }

        function toggleMode(isAdvanced) {
            mode = isAdvanced ? "advanced" : "normal";
            // æŒ‰é’®é«˜äº®
            document.getElementById('normalModeBtn').classList.toggle('active', mode === 'normal');
            document.getElementById('advancedModeBtn').classList.toggle('active', mode === 'advanced');
            log('å·²åˆ‡æ¢ä¸º' + (isAdvanced ? 'é«˜çº§æ¨¡å¼' : 'æ™®é€šæ¨¡å¼'), 'info');
            if (currentTemplate) renderFieldEditor(currentTemplate);
        }
    </script>
</body>
</html> 