<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket动态数据模拟器</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        .section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.received {
            color: #68d391;
        }
        .log-entry.sent {
            color: #63b3ed;
        }
        .log-entry.error {
            color: #fc8181;
        }
        .log-entry.info {
            color: #f6e05e;
        }
        .template-editor {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .field-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .field-path {
            flex: 1;
            font-weight: 600;
            color: #495057;
            margin-right: 10px;
        }
        .field-type-select {
            width: 150px;
            margin-right: 10px;
        }
        .field-value {
            flex: 2;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #6c757d;
        }
        .field-limits {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
        .field-limits input {
            width: 80px;
            margin: 0 5px;
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
        }
        .field-limits label {
            font-size: 11px;
            color: #6c757d;
            margin: 0 2px;
        }
        .preview-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .preview-json {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .connection-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .connection-count {
            font-weight: 600;
            color: #1976d2;
        }
        /* 悬浮日志容器 */
        #floatingLogContainer {
            position: fixed;
            top: 80px;
            right: 40px;
            width: 372px;
            max-height: 70vh;
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            z-index: 9999;
            overflow-y: auto;
            padding: 18px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            transition: opacity 0.2s, visibility 0.2s;
        }
        #floatingLogContainer.hide {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        /* 悬浮日志开关按钮 */
        #toggleLogBtn {
            position: fixed;
            right: 48px;
            bottom: 48px;
            z-index: 10000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, box-shadow 0.2s;
        }
        #toggleLogBtn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            box-shadow: 0 8px 32px rgba(0,0,0,0.22);
        }
        .mode-btn {
            /* 不再单独设置宽高、字体、padding、圆角等，全部继承button */
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: #fff !important;
            border: 1px solid #667eea !important;
        }
        .push-interval-group {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔌 WebSocket动态数据模拟器</h1>
            <p>支持智能数据类型识别和交互式模板编辑</p>
        </div>
        
        <div class="content">
            <!-- 左侧：连接和模板编辑 -->
            <div class="left-panel">
                <!-- 连接控制 -->
                <div class="section">
                    <h3>🔗 连接控制</h3>
                    <div class="connection-info">
                        <span>当前连接数: <span id="connectionCount" class="connection-count">0</span></span>
                        <span id="connectionStatus" class="status disconnected">未连接</span>
                    </div>
                    <div class="controls">
                        <div class="push-interval-group">
                            <label style="margin-right:8px; font-weight:400; color:#495057;white-space:nowrap;">
                                推送频率(秒):
                                <input id="pushIntervalInput" type="number" min="0.1" step="0.1" value="5" style="width:60px;display:inline-block;margin-left:4px;vertical-align:middle;">
                            </label>
                            <button id="changePushIntervalBtn" onclick="changePushInterval()">修改推送频率</button>
                        </div>
                        <div class="push-interval-group" style="display:none;">
                            <label style="margin-right:8px; font-weight:400; color:#495057;white-space:nowrap;">
                                生成组数:
                                <input id="groupCountInput" type="number" min="1" max="3" value="1" style="width:60px;display:inline-block;margin-left:4px;vertical-align:middle;">
                            </label>
                        </div>
                        <div style="display:inline-block;width:100%;margin-top:4px;">
                            <button id="connectBtn" onclick="connect()">连接</button>
                            <button id="disconnectBtn" onclick="disconnect()" disabled>断开</button>
                            <button onclick="clearLog()">清空日志</button>
                            <button onclick="getConnectionCount()">刷新连接数</button>
                            <button id="normalModeBtn" type="button" class="mode-btn" onclick="toggleMode(false)">普通模式</button>
                            <button id="advancedModeBtn" type="button" class="mode-btn" onclick="toggleMode(true)">高级模式</button>
                        </div>
                    </div>
                </div>

                <!-- 模板编辑器 -->
                <div class="section">
                    <h3>📝 交互式模板编辑器</h3>
                    <div class="input-group">
                        <label for="jsonInput">输入JSON模板:</label>
                        <textarea id="jsonInput" rows="8" placeholder='{"user_id": 0, "user_name": "", "age": 0, "email": "", "is_active": false}'></textarea>
                    </div>
                    <div class="controls">
                        <button onclick="parseAndEditTemplate()">解析并编辑</button>
                        <button onclick="generateRandomTemplate()">生成示例模板</button>
                        <button onclick="clearTemplate()">清空模板</button>
                        <button id="testFieldEditorBtn">测试字段编辑器</button>
                    </div>
                    
                    <div id="templateEditor" class="template-editor" style="display: none;">
                        <h4>字段类型配置</h4>
                        <div id="fieldList"></div>
                        <div class="controls">
                            <button id="applyTemplateBtn" onclick="applyTemplate()">应用模板</button>
                            <button id="updateTemplateBtn" onclick="updateAndReconnectTemplate()" style="display:none;">更新应用模板</button>
                            <button onclick="previewTemplate()">预览数据</button>
                        </div>
                    </div>
                </div>

                <!-- 数据预览 -->
                <div class="section">
                    <h3>👀 数据预览</h3>
                    <div class="preview-section">
                        <div id="previewContent" class="preview-json">等待生成数据...</div>
                    </div>
    </div>
    </div>
    </div>
    </div>

    <!-- 悬浮日志容器 -->
    <div id="floatingLogContainer"></div>
    <!-- 悬浮日志开关按钮 -->
    <button id="toggleLogBtn" title="显示/隐藏实时日志" onclick="toggleLog()">📝</button>

    <script>
        let ws = null;
        let isConnected = false;
        let currentTemplate = null;
        let fieldTypes = {};
        let fieldLimits = {}; // 新增：存储字段的最大值最小值限制
        let mode = "normal";

        // 数据类型选项
        const dataTypes = [
            { value: 'auto', label: '自动识别' },
            { value: 'string', label: '字符串' },
            { value: 'int', label: '整数' },
            { value: 'double', label: '浮点数' },
            { value: 'boolean', label: '布尔值' },
            { value: 'array', label: '数组' },
            { value: 'object', label: '对象' },
            { value: 'email', label: '邮箱' },
            { value: 'phone', label: '手机号' },
            { value: 'date', label: '日期时间' },
            { value: 'timestamp_realtime', label: '实时时间戳(毫秒)' },
            { value: 'timestamp_editable', label: '可修改时间戳(毫秒)' },
            { value: 'ip', label: 'IP地址' },
            { value: 'url', label: 'URL' },
            { value: 'uuid', label: 'UUID' },
            { value: 'name', label: '姓名' },
            { value: 'color', label: '颜色' },
            { value: 'age', label: '年龄(1-100)' },
            { value: 'year', label: '年份(2000-2024)' },
            { value: 'month', label: '月份(1-12)' },
            { value: 'day', label: '日期(1-31)' },
            { value: 'hour', label: '小时(0-23)' },
            { value: 'minute', label: '分钟(0-59)' },
            { value: 'second', label: '秒(0-59)' },
            { value: 'port', label: '端口(1024-65535)' },
            { value: 'id', label: 'ID(1-1000000)' },
            { value: 'price', label: '价格(0-1000)' },
            { value: 'rate', label: '比率(0-100%)' },
            { value: 'score', label: '分数(0-10)' },
            { value: 'temperature', label: '温度(-10-40)' },
            { value: 'latitude', label: '纬度(-90-90)' },
            { value: 'longitude', label: '经度(-180-180)' }
        ];

        function isNumericType(type) {
            return [
                'int', 'double', 'age', 'year', 'month', 'day', 'hour', 'minute', 'second',
                'port', 'id', 'price', 'rate', 'score', 'temperature', 'latitude', 'longitude'
            ].includes(type);
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('已经连接', 'info');
                return;
            }

            // 使用相对路径，自动匹配当前协议和主机
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}/`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                isConnected = true;
                updateConnectionStatus();
                updateTemplateButtons();
                log('WebSocket连接已建立', 'info');
            };

            ws.onmessage = function(event) {
                log('收到: ' + event.data, 'received');
                    try {
                        const data = JSON.parse(event.data);
                    updatePreview(JSON.stringify(data, null, 2));
                    } catch (e) {
                    updatePreview(event.data);
                }
            };

            ws.onclose = function() {
                isConnected = false;
                updateConnectionStatus();
                updateTemplateButtons();
                log('WebSocket连接已关闭', 'info');
            };

            ws.onerror = function(error) {
                log('WebSocket错误: ' + error, 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (isConnected) {
                status.textContent = '已连接';
                status.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                status.textContent = '未连接';
                status.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function updateTemplateButtons() {
            const applyBtn = document.getElementById('applyTemplateBtn');
            const updateBtn = document.getElementById('updateTemplateBtn');
            if (isConnected) {
                applyBtn.style.display = 'none';
                updateBtn.style.display = '';
            } else {
                applyBtn.style.display = '';
                updateBtn.style.display = 'none';
            }
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('floatingLogContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('floatingLogContainer').innerHTML = '';
        }

        function getConnectionCount() {
            fetch('/api/connection-count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('connectionCount').textContent = data.count;
                })
                .catch(error => {
                    log('获取连接数失败: ' + error, 'error');
                });
        }

        function parseAndEditTemplate() {
            const jsonInput = document.getElementById('jsonInput').value.trim();
            if (!jsonInput) {
                alert('请输入JSON模板');
                return;
            }

            try {
                const template = JSON.parse(jsonInput);
                currentTemplate = template;
                fieldTypes = {};
                renderFieldEditor(template);
                document.getElementById('templateEditor').style.display = 'block';
                log('模板解析成功，请配置字段类型', 'info');
            } catch (error) {
                alert('JSON格式错误: ' + error.message);
                log('JSON解析失败: ' + error.message, 'error');
            }
        }

        function renderFieldEditor(obj, path = '') {
            const fieldList = document.getElementById('fieldList');
            fieldList.innerHTML = '';
            // 高级模式下，允许为任意路径配置；普通模式下只允许[0]路径
            function addFields(obj, currentPath) {
                if (Array.isArray(obj)) {
                    if (obj.length > 0) {
                        if (mode === 'advanced') {
                            for (let i = 0; i < Math.min(obj.length, 3); i++) {
                                addFields(obj[i], currentPath + '[' + i + ']');
                            }
                        } else {
                            addFields(obj[0], currentPath + '[0]');
                        }
                    }
                } else if (typeof obj === 'object' && obj !== null) {
                    for (const [key, value] of Object.entries(obj)) {
                        const fieldPath = currentPath ? `${currentPath}.${key}` : key;
                        if (mode === 'normal' && /\[\d+\]/.test(fieldPath) && !/\[0\]/.test(fieldPath)) continue;
                        // --- data字段特殊处理 ---
                        if (fieldPath === 'data') {
                            const fieldRow = document.createElement('div');
                            fieldRow.className = 'field-row';
                            const fieldPathSpan = document.createElement('div');
                            fieldPathSpan.className = 'field-path';
                            fieldPathSpan.textContent = fieldPath;
                            fieldRow.appendChild(fieldPathSpan);
                            // 类型下拉框
                            const typeSelect = document.createElement('select');
                            typeSelect.className = 'field-type-select';
                            ['array', 'object'].forEach(type => {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = type === 'array' ? '数组' : '对象';
                                typeSelect.appendChild(option);
                            });
                            // 自动识别类型
                            typeSelect.value = Array.isArray(value) ? 'array' : 'object';
                            typeSelect.onchange = function() {
                                // 切换类型时，自动更新模板内容
                                if (this.value === 'array' && !Array.isArray(value)) {
                                    currentTemplate.data = [{}];
                                } else if (this.value === 'object' && Array.isArray(value)) {
                                    currentTemplate.data = {};
                                }
                                // 重新渲染
                                renderFieldEditor(currentTemplate);
                            };
                            fieldRow.appendChild(typeSelect);
                            // data值显示
                            const fieldValue = document.createElement('div');
                            fieldValue.className = 'field-value';
                            fieldValue.textContent = JSON.stringify(value);
                            fieldRow.appendChild(fieldValue);
                            fieldList.appendChild(fieldRow);
                            // 递归
                            if (typeof value === 'object' && value !== null) {
                                addFields(value, fieldPath);
                            }
                            continue;
                        }
                        // --- 其他字段原有渲染逻辑 ---
                        const fieldRow = document.createElement('div');
                        fieldRow.className = 'field-row';
                        const fieldPathSpan = document.createElement('div');
                        fieldPathSpan.className = 'field-path';
                        fieldPathSpan.textContent = fieldPath;
                        const typeSelect = document.createElement('select');
                        typeSelect.className = 'field-type-select';
                        typeSelect.onchange = function() {
                            fieldTypes[fieldPath] = this.value;
                            if (minInput) minInput.value = '';
                            if (maxInput) maxInput.value = '';
                            if (defaultInput) defaultInput.value = '';
                            if (isNumericType(this.value)) {
                                minInput.type = 'number';
                                maxInput.type = 'number';
                                minInput.placeholder = '最小值';
                                maxInput.placeholder = '最大值';
                                defaultInput.type = 'number';
                                defaultInput.placeholder = '默认值';
                                minInput.disabled = false;
                                maxInput.disabled = false;
                                defaultInput.disabled = false;
                                if (minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip') minInput.nextElementSibling.remove();
                            } else if (this.value === 'date') {
                                minInput.type = 'datetime-local';
                                maxInput.type = 'datetime-local';
                                minInput.placeholder = '最小日期时间';
                                maxInput.placeholder = '最大日期时间';
                                defaultInput.type = 'datetime-local';
                                defaultInput.placeholder = '默认日期时间';
                                minInput.disabled = false;
                                maxInput.disabled = false;
                                defaultInput.disabled = false;
                                if (minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip') minInput.nextElementSibling.remove();
                            } else if (this.value === 'timestamp_realtime') {
                                minInput.type = 'number';
                                maxInput.type = 'number';
                                defaultInput.type = 'number';
                                minInput.value = '';
                                maxInput.value = '';
                                defaultInput.value = '';
                                minInput.disabled = true;
                                maxInput.disabled = true;
                                defaultInput.disabled = true;
                                if (!(minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip')) {
                                    const tip = document.createElement('span');
                                    tip.className = 'ts-tip';
                                    tip.style.color = '#888';
                                    tip.style.marginLeft = '8px';
                                    minInput.parentNode.insertBefore(tip, minInput.nextSibling);
                                }
                            } else if (this.value === 'timestamp_editable') {
                                minInput.type = 'number';
                                maxInput.type = 'number';
                                defaultInput.type = 'number';
                                minInput.placeholder = '最小时间戳(毫秒)';
                                maxInput.placeholder = '最大时间戳(毫秒)';
                                defaultInput.placeholder = '默认时间戳(毫秒)';
                                minInput.disabled = false;
                                maxInput.disabled = false;
                                defaultInput.disabled = false;
                                if (minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip') minInput.nextElementSibling.remove();
                            } else {
                                minInput.type = 'text';
                                maxInput.type = 'text';
                                minInput.placeholder = '最小值';
                                maxInput.placeholder = '最大值';
                                defaultInput.type = 'text';
                                defaultInput.placeholder = '默认值';
                                minInput.disabled = false;
                                maxInput.disabled = false;
                                defaultInput.disabled = false;
                                if (minInput.nextElementSibling && minInput.nextElementSibling.className === 'ts-tip') minInput.nextElementSibling.remove();
                            }
                        };
                        dataTypes.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type.value;
                            option.textContent = type.label;
                            typeSelect.appendChild(option);
                        });
                        const defaultType = getDefaultType(key, value);
                        typeSelect.value = defaultType;
                        fieldTypes[fieldPath] = defaultType;
                        const fieldValue = document.createElement('div');
                        fieldValue.className = 'field-value';
                        fieldValue.textContent = JSON.stringify(value);
                        const fieldLimits = document.createElement('div');
                        fieldLimits.className = 'field-limits';
                        let minInput = null, maxInput = null, defaultInput = null;
                        if (isNumericType(defaultType) || defaultType === 'date') {
                            const minLabel = document.createElement('label');
                            minLabel.textContent = '最小:';
                            fieldLimits.appendChild(minLabel);
                            minInput = document.createElement('input');
                            minInput.type = isNumericType(defaultType) ? 'number' : (defaultType === 'date' ? 'datetime-local' : 'text');
                            minInput.placeholder = isNumericType(defaultType) ? '最小值' : (defaultType === 'date' ? '最小日期时间' : '最小值');
                            minInput.onchange = function() {
                                if (!fieldLimitsObj[fieldPath]) fieldLimitsObj[fieldPath] = {};
                                fieldLimitsObj[fieldPath].min = this.value;
                            };
                            fieldLimits.appendChild(minInput);
                            const maxLabel = document.createElement('label');
                            maxLabel.textContent = '最大:';
                            fieldLimits.appendChild(maxLabel);
                            maxInput = document.createElement('input');
                            maxInput.type = isNumericType(defaultType) ? 'number' : (defaultType === 'date' ? 'datetime-local' : 'text');
                            maxInput.placeholder = isNumericType(defaultType) ? '最大值' : (defaultType === 'date' ? '最大日期时间' : '最大值');
                            maxInput.onchange = function() {
                                if (!fieldLimitsObj[fieldPath]) fieldLimitsObj[fieldPath] = {};
                                fieldLimitsObj[fieldPath].max = this.value;
                            };
                            fieldLimits.appendChild(maxInput);
                            // 默认值输入框
                            const defaultLabel = document.createElement('label');
                            defaultLabel.textContent = '默认:';
                            fieldLimits.appendChild(defaultLabel);
                            defaultInput = document.createElement('input');
                            defaultInput.type = minInput.type;
                            defaultInput.placeholder = minInput.type === 'datetime-local' ? '默认日期时间' : '默认值';
                            defaultInput.onchange = function() {
                                if (!fieldDefaultsObj[fieldPath]) fieldDefaultsObj[fieldPath] = {};
                                fieldDefaultsObj[fieldPath].value = this.value;
                            };
                            fieldLimits.appendChild(defaultInput);
                        } else {
                            // 默认值输入框
                            const defaultLabel = document.createElement('label');
                            defaultLabel.textContent = '默认:';
                            fieldLimits.appendChild(defaultLabel);
                            defaultInput = document.createElement('input');
                            defaultInput.type = 'text';
                            defaultInput.placeholder = '默认值';
                            defaultInput.onchange = function() {
                                if (!fieldDefaultsObj[fieldPath]) fieldDefaultsObj[fieldPath] = {};
                                fieldDefaultsObj[fieldPath].value = this.value;
                            };
                            fieldLimits.appendChild(defaultInput);
                        }
                        fieldRow.appendChild(fieldPathSpan);
                        fieldRow.appendChild(typeSelect);
                        fieldRow.appendChild(fieldValue);
                        fieldRow.appendChild(fieldLimits);
                        fieldList.appendChild(fieldRow);
                        if (typeof value === 'object' && value !== null) {
                            addFields(value, fieldPath);
                        }
                    }
                }
            }
            let fieldLimitsObj = fieldLimits;
            let fieldDefaultsObj = {};
            addFields(obj, path);
            window._fieldDefaultsObj = fieldDefaultsObj;
        }

        function getDefaultType(key, value) {
            const lowerKey = key.toLowerCase();
            
            // 根据字段名和值类型推断默认类型
            if (typeof value === 'number') {
                if (Number.isInteger(value)) {
                    if (lowerKey.includes('age')) return 'age';
                    if (lowerKey.includes('year')) return 'year';
                    if (lowerKey.includes('month')) return 'month';
                    if (lowerKey.includes('day')) return 'day';
                    if (lowerKey.includes('hour')) return 'hour';
                    if (lowerKey.includes('minute')) return 'minute';
                    if (lowerKey.includes('second')) return 'second';
                    if (lowerKey.includes('port')) return 'port';
                    if (lowerKey.includes('id')) return 'id';
                    if (lowerKey.includes('type')) return 'int';
                    return 'int';
                } else {
                    if (lowerKey.includes('price')) return 'price';
                    if (lowerKey.includes('rate')) return 'rate';
                    if (lowerKey.includes('score')) return 'score';
                    if (lowerKey.includes('temperature')) return 'temperature';
                    if (lowerKey.includes('latitude')) return 'latitude';
                    if (lowerKey.includes('longitude')) return 'longitude';
                    if (lowerKey.includes('x') || lowerKey.includes('y') || lowerKey.includes('z')) return 'double';
                    if (lowerKey.includes('a') || lowerKey.includes('d')) return 'double';
                    return 'double';
                }
            } else if (typeof value === 'boolean') {
                return 'boolean';
            } else if (typeof value === 'string') {
                if (lowerKey.includes('email')) return 'email';
                if (lowerKey.includes('phone') || lowerKey.includes('mobile')) return 'phone';
                if (lowerKey.includes('date') || lowerKey.includes('time')) return 'date';
                if (lowerKey.includes('ip')) return 'ip';
                if (lowerKey.includes('url')) return 'url';
                if (lowerKey.includes('uuid') || lowerKey.includes('guid')) return 'uuid';
                if (lowerKey.includes('name')) return 'name';
                if (lowerKey.includes('color')) return 'color';
                return 'string';
            } else if (Array.isArray(value)) {
                return 'array';
            } else if (typeof value === 'object' && value !== null) {
                return 'object';
            }
            
            return 'auto';
        }

        function applyTemplate() {
            if (!currentTemplate) {
                alert('请先解析模板');
                return;
            }
            if (!isConnected) {
                connect();
                let tryCount = 0;
                const trySend = setInterval(() => {
                    if (isConnected) {
                        clearInterval(trySend);
                        _doApplyTemplate();
                    } else if (++tryCount > 20) {
                        clearInterval(trySend);
                        alert('连接超时，无法应用模板');
                    }
                }, 200);
            } else {
                _doApplyTemplate();
            }
        }

        function _doApplyTemplate() {
            const pushInterval = parseFloat(document.getElementById('pushIntervalInput').value) || 5;
            const groupCount = Math.max(1, Math.min(3, parseInt(document.getElementById('groupCountInput').value) || 1));
            const modifiedTemplate = modifyTemplateByTypes(currentTemplate, fieldTypes);
            const newFieldLimits = {};
            document.querySelectorAll('.field-row').forEach(row => {
                const path = row.querySelector('.field-path').textContent;
                const minInput = row.querySelector('.field-limits input[placeholder^="最小"]');
                const maxInput = row.querySelector('.field-limits input[placeholder^="最大"]');
                if (minInput && minInput.value !== "") {
                    if (!newFieldLimits[path]) newFieldLimits[path] = {};
                    newFieldLimits[path].min = minInput.value;
                }
                if (maxInput && maxInput.value !== "") {
                    if (!newFieldLimits[path]) newFieldLimits[path] = {};
                    newFieldLimits[path].max = maxInput.value;
                }
            });
            const fieldDefaults = window._fieldDefaultsObj || {};
            const templateConfig = {
                template: modifiedTemplate,
                fieldTypes: fieldTypes,
                fieldLimits: newFieldLimits,
                fieldDefaults: fieldDefaults,
                pushInterval: pushInterval,
                groupCount: groupCount,
                mode: mode // 关键：发送当前模式
            };
            const templateJson = JSON.stringify(templateConfig);
            ws.send(templateJson);
            log('发送模板配置: ' + templateJson, 'sent');
            document.getElementById('jsonInput').value = JSON.stringify(modifiedTemplate, null, 2);
        }

        function modifyTemplateByTypes(template, types) {
            const modified = JSON.parse(JSON.stringify(template));
            
            function modifyObject(obj, path = '') {
                if (Array.isArray(obj)) {
                    // 处理数组类型
                    if (obj.length > 0) {
                        modifyObject(obj[0], path + '[0]');
                    }
                } else if (typeof obj === 'object' && obj !== null) {
                    // 处理对象类型
                    for (const [key, value] of Object.entries(obj)) {
                        const fieldPath = path ? `${path}.${key}` : key;
                        const type = types[fieldPath];
                        
                        if (type && type !== 'auto') {
                            // 根据选择的类型设置默认值
                            switch (type) {
                                case 'string':
                                case 'email':
                                case 'phone':
                                case 'date':
                                case 'ip':
                                case 'url':
                                case 'uuid':
                                case 'name':
                                case 'color':
                                    obj[key] = '';
                                    break;
                                case 'int':
                                case 'age':
                                case 'year':
                                case 'month':
                                case 'day':
                                case 'hour':
                                case 'minute':
                                case 'second':
                                case 'port':
                                case 'id':
                                    obj[key] = 0;
                                    break;
                                case 'double':
                                case 'price':
                                case 'rate':
                                case 'score':
                                case 'temperature':
                                case 'latitude':
                                case 'longitude':
                                    obj[key] = 0.0;
                                    break;
                                case 'boolean':
                                    obj[key] = false;
                                    break;
                                case 'array':
                                    // 保持数组结构，只修改数组元素的默认值
                                    if (Array.isArray(obj[key]) && obj[key].length > 0) {
                                        // 递归处理数组的第一个元素
                                        modifyObject(obj[key][0], fieldPath + '[0]');
                                    }
                                    break;
                                case 'object':
                                    // 保持对象结构，只修改对象字段的默认值
                                    if (typeof obj[key] === 'object' && obj[key] !== null) {
                                        modifyObject(obj[key], fieldPath);
                                    }
                                    break;
                            }
                        }
                        
                        // 递归处理嵌套对象和数组
                        if (typeof obj[key] === 'object' && obj[key] !== null) {
                            modifyObject(obj[key], fieldPath);
                        }
                    }
                }
            }
            
            modifyObject(modified);
            return modified;
        }

        function previewTemplate() {
            if (!currentTemplate) {
                alert('请先解析模板');
                return;
            }

            const modifiedTemplate = modifyTemplateByTypes(currentTemplate, fieldTypes);
            updatePreview(JSON.stringify(modifiedTemplate, null, 2));
            log('模板预览已更新', 'info');
        }

        function updatePreview(content) {
            document.getElementById('previewContent').textContent = content;
        }

        function generateRandomTemplate() {
            const templates = [
                {
                    "user_id": 0,
                    "user_name": "",
                    "user_email": "",
                    "age": 0,
                    "phone": "",
                    "is_active": false,
                    "score": 0.0,
                    "registration_date": ""
                },
                {
                    "product_id": 0,
                    "product_name": "",
                    "price": 0.0,
                    "category": "",
                    "in_stock": false,
                    "rating": 0.0,
                    "tags": [""]
                },
                {
                    "sensor_id": 0,
                    "temperature": 0.0,
                    "humidity": 0.0,
                    "location": {
                        "latitude": 0.0,
                        "longitude": 0.0
                    },
                    "timestamp": "",
                    "is_online": false
                }
            ];
            
            const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
            document.getElementById('jsonInput').value = JSON.stringify(randomTemplate, null, 2);
            log('已生成示例模板', 'info');
        }

        function clearTemplate() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('templateEditor').style.display = 'none';
            document.getElementById('fieldList').innerHTML = '';
            currentTemplate = null;
            fieldTypes = {};
            fieldLimits = {}; // 清空字段限制
            updatePreview('等待生成数据...');
            log('模板已清空', 'info');
        }

        // 定期更新连接数
        setInterval(getConnectionCount, 5000);
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            getConnectionCount();
            // 默认模板
            const defaultTemplate = {"data": [{"id": 4341, "type": 1, "x": -14.392636016309739, "y": 45.06815540454186, "z": 0.0, "a": 4.927792, "d": 13.49925944656905}]};
            document.getElementById('jsonInput').value = JSON.stringify(defaultTemplate, null, 2);
            parseAndEditTemplate();
            // 按钮高亮初始化
            document.getElementById('normalModeBtn').classList.add('active');
            // 添加测试按钮用于验证功能
            const testButton = document.getElementById('testFieldEditorBtn');
            testButton.onclick = function() {
                const testTemplate = {
                    "user_id": 0,
                    "user_name": "",
                    "age": 0,
                    "email": "",
                    "is_active": false,
                    "location": {
                        "latitude": 0.0,
                        "longitude": 0.0
                    }
                };
                document.getElementById('jsonInput').value = JSON.stringify(testTemplate, null, 2);
                parseAndEditTemplate();
            };
        });

        function toggleLog() {
            const logContainer = document.getElementById('floatingLogContainer');
            logContainer.classList.toggle('hide');
        }

        function changePushInterval() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('请先建立WebSocket连接');
                return;
            }
            const pushInterval = parseFloat(document.getElementById('pushIntervalInput').value) || 1;
            if (pushInterval < 0.1) {
                alert('推送频率不能小于0.1秒');
                return;
            }
            const msg = JSON.stringify({ pushInterval });
            ws.send(msg);
            log('发送推送频率调整: ' + msg, 'sent');
        }

        function updateAndReconnectTemplate() {
            if (!currentTemplate) {
                alert('请先解析模板');
                return;
            }
            if (ws) {
                ws.onclose = function() {
                    isConnected = false;
                    updateConnectionStatus();
                    updateTemplateButtons();
                    log('WebSocket连接已关闭，准备重连', 'info');
                    // 断开后自动重连并应用模板
                    connect();
                    let tryCount = 0;
                    const trySend = setInterval(() => {
                        if (isConnected) {
                            clearInterval(trySend);
                            _doApplyTemplate();
                        } else if (++tryCount > 20) {
                            clearInterval(trySend);
                            alert('重连超时，无法应用模板');
                        }
                    }, 200);
                };
                ws.close();
            } else {
                connect();
                let tryCount = 0;
                const trySend = setInterval(() => {
                    if (isConnected) {
                        clearInterval(trySend);
                        _doApplyTemplate();
                    } else if (++tryCount > 20) {
                        clearInterval(trySend);
                        alert('重连超时，无法应用模板');
                    }
                }, 200);
            }
        }

        function toggleMode(isAdvanced) {
            mode = isAdvanced ? "advanced" : "normal";
            // 按钮高亮
            document.getElementById('normalModeBtn').classList.toggle('active', mode === 'normal');
            document.getElementById('advancedModeBtn').classList.toggle('active', mode === 'advanced');
            log('已切换为' + (isAdvanced ? '高级模式' : '普通模式'), 'info');
            if (currentTemplate) renderFieldEditor(currentTemplate);
        }
    </script>
</body>
</html> 