<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket动态格式测试客户端</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background: #f4f6fa;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 18px auto 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 18px 18px 10px 18px;
        }
        h1 {
            font-size: 1.3rem;
            margin: 0 0 10px 0;
            text-align: center;
            color: #2c3e50;
        }
        .row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .row label {
            margin-right: 6px;
            font-size: 14px;
            color: #555;
        }
        .row input[type=text], .row input[type=number] {
            padding: 3px 7px;
            border-radius: 3px;
            border: 1px solid #ccc;
            font-size: 14px;
            margin-right: 10px;
            width: 110px;
        }
        .row input[type=number] { width: 70px; }
        .row input[type=text][id=path] { width: 150px; }
        .row textarea {
            width: 100%;
            min-height: 70px;
            font-family: monospace;
            font-size: 13px;
            border-radius: 4px;
            border: 1px solid #ccc;
            padding: 6px;
            resize: vertical;
        }
        .status {
            padding: 7px 10px;
            margin: 8px 0 8px 0;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 7px 16px;
            margin: 0 6px 0 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover { background-color: #0056b3; }
        .button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .data-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0 0 0;
            font-size: 13px;
            max-height: 180px;
            overflow-y: auto;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0 0 0;
            font-size: 12px;
            max-height: 120px;
            overflow-y: auto;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .online-count {
            font-size: 14px;
            color: #007bff;
            font-weight: bold;
        }
        @media (max-width: 1000px) {
            .container { max-width: 99vw; }
        }
        @media (max-width: 700px) {
            .row { flex-direction: column; align-items: flex-start; }
            .row input, .row textarea { width: 100% !important; margin-bottom: 6px; }
            .top-bar { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="top-bar">
        <h1>WebSocket动态格式测试客户端</h1>
        <span class="online-count" id="onlineCount">连接数: --</span>
    </div>
    <div class="row">
        <label>IP:</label><input type="text" id="ip" value="localhost">
        <label>端口:</label><input type="number" id="port" value="1883" min="1" max="65535">
    </div>
    <div class="row">
        <label style="min-width:110px;">JSON请求示例：</label>
        <textarea id="jsonTemplate">{
  "id": "string",
  "type": 1,
  "x": 0.0,
  "y": 0.0,
  "flag": true,
  "meta": {"desc": "string", "score": 0},
  "tags": ["a", "b"],
  "points": [{"x": 1, "y": 2}]
}</textarea>
    </div>
    <div id="status" class="status disconnected">连接状态: 未连接</div>
    <div class="row" style="margin-bottom:0;">
        <button id="connectBtn" class="button" onclick="connect()">连接</button>
        <button id="disconnectBtn" class="button" onclick="disconnect()" disabled>断开</button>
        <button id="sendBtn" class="button" onclick="sendMessage()" disabled>发送消息</button>
        <button id="clearLogBtn" class="button" onclick="clearLog()">清空日志</button>
    </div>
    <div>
        <h3 style="margin:10px 0 5px 0;font-size:15px;">接收的数据</h3>
        <div id="dataDisplay" class="data-display"><p>暂无数据</p></div>
    </div>
    <div>
        <h3 style="margin:10px 0 5px 0;font-size:15px;">连接日志</h3>
        <div id="log" class="log"><p>等待连接...</p></div>
    </div>
</div>
<script>
    let websocket = null;
    let messageCount = 0;
    let jsonTemplate = "";
    let onlineCountTimer = null;

    function connect() {
        const ip = document.getElementById('ip').value.trim();
        const port = document.getElementById('port').value.trim();
        const wsUrl = `ws://${ip}:${port}/`;
        jsonTemplate = document.getElementById('jsonTemplate').value.trim();
        // 校验JSON格式
        try {
            JSON.parse(jsonTemplate);
        } catch (e) {
            alert('JSON格式不合法，请检查！\n' + e.message);
            return;
        }
        addLog('尝试连接: ' + wsUrl);
        try {
            websocket = new WebSocket(wsUrl);
            websocket.onopen = function(event) {
                updateStatus('已连接', true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                addLog('WebSocket连接已建立，发送json示例...');
                websocket.send(jsonTemplate);
            };
            websocket.onmessage = function(event) {
                messageCount++;
                addLog(`收到消息 #${messageCount}: ${event.data}`);
                try {
                    const data = JSON.parse(event.data);
                    displayData(data);
                } catch (e) {
                    addLog('JSON解析失败: ' + e.message);
                }
            };
            websocket.onclose = function(event) {
                updateStatus('连接已关闭', false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                addLog('WebSocket连接已关闭');
            };
            websocket.onerror = function(error) {
                updateStatus('连接错误', false);
                addLog('WebSocket连接错误: ' + error);
            };
        } catch (error) {
            addLog('连接失败: ' + error.message);
        }
    }
    function disconnect() {
        if (websocket) {
            websocket.close();
            websocket = null;
        }
    }
    function sendMessage() {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            const message = '测试消息 ' + new Date().toLocaleTimeString();
            websocket.send(message);
            addLog('发送消息: ' + message);
        }
    }
    function updateStatus(message, connected) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = '连接状态: ' + message;
        statusDiv.className = 'status ' + (connected ? 'connected' : 'disconnected');
    }
    function displayData(data) {
        const displayDiv = document.getElementById('dataDisplay');
        displayDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }
    function addLog(message) {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<span style=\"color: #6c757d;\">[${timestamp}]</span> ${message}`;
        if (logDiv.children.length === 0) logDiv.innerHTML = '';
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    function clearLog() {
        document.getElementById('log').innerHTML = '<p>等待连接...</p>';
        messageCount = 0;
    }
    function fetchOnlineCount() {
        const ip = document.getElementById('ip').value.trim();
        const port = document.getElementById('port').value.trim();
        fetch(`http://${ip}:${port}/api/connection-count`).then(r=>r.json()).then(data=>{
            document.getElementById('onlineCount').textContent = '连接数: ' + data.count;
        }).catch(()=>{
            document.getElementById('onlineCount').textContent = '连接数: --';
        });
    }
    window.onload = function() {
        addLog('测试客户端已加载');
        addLog('请填写json示例后点击"连接"');
        fetchOnlineCount();
        onlineCountTimer = setInterval(fetchOnlineCount, 3000);
    };
    window.onbeforeunload = function() {
        if (websocket) websocket.close();
        if (onlineCountTimer) clearInterval(onlineCountTimer);
    };
</script>
</body>
</html> 